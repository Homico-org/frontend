name: Deploy

on:
  push:
    branches: [dev, main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Trigger Render Deploy Hook
    runs-on: ubuntu-latest

    steps:
      - name: Resolve deploy hook URL
        id: resolve
        shell: bash
        run: |
          if [ "${GITHUB_REF}" = "refs/heads/dev" ]; then
            URL="${{ secrets.RENDER_DEPLOY_HOOK_URL_DEV }}"
            if [ -z "${URL}" ]; then URL="${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND_DEV }}"; fi
          elif [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            URL="${{ secrets.RENDER_DEPLOY_HOOK_URL_MAIN }}"
            if [ -z "${URL}" ]; then URL="${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND_PROD }}"; fi
          else
            URL=""
          fi

          echo "url=${URL}" >> "$GITHUB_OUTPUT"

      - name: Trigger deploy
        if: steps.resolve.outputs.url != ''
        run: |
          set -euo pipefail
          URL="${{ steps.resolve.outputs.url }}"

          # Render deploy hooks may return 409 when a deploy is already in progress/queued.
          # Treat 2xx and 409 as success.
          http_code="$(curl -sS -o /tmp/render_deploy_response.txt -w "%{http_code}" -X POST "${URL}" || true)"
          if [[ "${http_code}" =~ ^2[0-9]{2}$ || "${http_code}" == "409" ]]; then
            echo "Deploy hook accepted (HTTP ${http_code})."
          else
            echo "Deploy hook failed (HTTP ${http_code}). Response:"
            cat /tmp/render_deploy_response.txt || true
            exit 1
          fi

      - name: Skip (no deploy hook configured)
        if: steps.resolve.outputs.url == ''
        run: |
          echo "No Render deploy hook secret configured for this branch; skipping deploy."
